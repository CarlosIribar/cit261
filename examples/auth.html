<!DOCTYPE html>
<html>
  <head>
    <title>
      Authentication
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .errors {
        border: 1px solid darkred;
        background-color: lightcoral;
        padding: 0.5em;
      }
      form input {
        margin: 0.5em 0;
        font-size: 1.4em;
        background-color: antiquewhite;
        width: 300px;
      }
      form button {
        font-size: 1.2em;
        padding: 0.4em;
        background-color: cornflowerblue;
      }
      input:invalid {
        box-shadow: 0 0 5px 1px red;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="text-center">Authentication Example</h1>
      <nav></nav>
    </header>
    <div id="errors" class="errors hidden"></div>
    <div id="login">
      <form>
        <div>
          <label for="username">Username</label>
          <input
            type="text"
            class="form-control"
            id="username"
            placeholder="Username"
            value="user1@email.com"
          />
        </div>
        <div>
          <label for="password">Password</label>
          <input
            type="password"
            class="form-control"
            id="password"
            placeholder="Password"
          />
        </div>
        <button type="button" class="btn btn-primary center-block">
          Login
        </button>
      </form>
      <div id="token-display"></div>
    </div>

    <div id="posts" class="hidden">
      <form name="postForm">
        <div>
          <label for="title">Title</label>
          <input
            type="text"
            class="form-control"
            name="title"
            placeholder="title"
            required
          />
        </div>
        <div>
          <label for="content">Content</label>
          <input
            type="text"
            class="form-control"
            name="content"
            placeholder="content"
            required
          />
        </div>
        <div id="postError"></div>
        <!-- <button
          type="button"
          class="btn btn-primary center-block"
          onclick="createPost()"
        >
          New Post
        </button> -->
        <input type="submit" onclick="createPost()" />
      </form>
      <ul id="list"></ul>
    </div>
    <script type="module">
      import Auth from './auth.js';
      import { Errors, makeRequest } from './authHelpers.js';
      const authURL = 'http://127.0.0.1:3000/';

      const myErrors = new Errors('errors');
      const myAuth = new Auth('login', myErrors);
      async function getPosts() {
        try {
          const data = await makeRequest(
            authURL + 'posts',
            'GET',
            null,
            myAuth.token
          );
          // make sure the element is shown
          document.getElementById('posts').classList.remove('hidden');
          console.log(data);
          var ul = document.getElementById('list');
          ul.innerHTML = '';
          for (var i = 0; i < data.length; i++) {
            var li = document.createElement('li');
            li.appendChild(document.createTextNode(data[i].title));
            ul.appendChild(li);
          }
          myErrors.clearError();
        } catch (error) {
          // if there were any errors display them
          myErrors.handleError(error);
        }
      }

      async function createPost() {
        const form = document.forms.postForm;
        console.dir(form);
        if (form.title.validity.valid && form.content.validity.valid) {
          myErrors.clearError();
          const data = {
            title: form.title.value,
            content: form.content.value
          };
          try {
            const res = await makeRequest(
              authURL + 'posts',
              'POST',
              data,
              myAuth.token
            );
            console.log('Post create:', data);
            form.title.value = '';
            form.content.value = '';
            getPosts();
          } catch (error) {
            myErrors.handleError(error);
          }
        } else {
          myErrors.displayError({ message: 'Title and Content are required' });
        }
      }
    </script>
  </body>
</html>
